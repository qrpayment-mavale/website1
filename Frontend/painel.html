<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Pagamento MZN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .dashboard-card { 
            background: linear-gradient(145deg, #ffffff, #e6e6e6); 
            box-shadow: 8px 8px 16px #d9d9d9, -8px -8px 16px #ffffff; 
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
        }
        .text-green-revenue { color: #22c55e; } /* green-600 */
        .text-blue-users { color: #3b82f6; } /* blue-500 */
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-6 bg-gray-100">

    <div class="max-w-6xl w-full space-y-8">
        <h1 class="text-4xl font-extrabold text-gray-800 text-center mb-8">Painel de Controle</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="dashboard-card bg-green-50 border border-green-200">
                <p class="text-lg font-medium text-green-700 mb-2">TOTAL ARRECADADO (DEVICE: MOC001)</p>
                <p id="total-revenue" class="text-5xl font-extrabold text-green-revenue">0.00 MT</p> 
                <p class="text-sm text-gray-500 mt-2">Total de pagamentos na rota.</p>
            </div>

            <div class="dashboard-card bg-blue-50 border border-blue-200">
                <p class="text-lg font-medium text-blue-700 mb-2">TOTAL DE USUÁRIOS CADASTRADOS</p>
                <p id="total-users" class="text-5xl font-extrabold text-blue-users">0</p> 
                <p class="text-sm text-gray-500 mt-2">Contas aptas a pagar a tarifa.</p>
            </div>
        </div>

        <div class="dashboard-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Saldo Detalhado dos Usuários</h2>
                <button id="refresh-users-button" 
                        class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out">
                    Atualizar
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID DO USUÁRIO</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NOME</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SALDO (MT)</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="3">Carregando usuários...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="users-loading-message" class="text-center py-4 text-gray-500"></div>
        </div>

        <div class="dashboard-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Gerenciamento de Usuários</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Adicionar Novo Usuário</h3>
                    <form id="add-user-form" class="space-y-4">
                        <div>
                            <label for="new-user-id" class="block text-sm font-medium text-gray-700">ID do Usuário:</label>
                            <input type="text" id="new-user-id" required 
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="new-user-name" class="block text-sm font-medium text-gray-700">Nome:</label>
                            <input type="text" id="new-user-name" required 
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="new-user-balance" class="block text-sm font-medium text-gray-700">Saldo Inicial (MT):</label>
                            <input type="number" id="new-user-balance" required value="0.00" step="0.01"
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-500 hover:bg-green-600">
                            Adicionar Usuário
                        </button>
                        <div id="add-user-message" class="mt-2 text-center text-sm"></div>
                    </form>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Remover Usuário Existente</h3>
                    <form id="delete-user-form" class="space-y-4">
                        <div>
                            <label for="delete-user-id" class="block text-sm font-medium text-gray-700">ID do Usuário:</label>
                            <input type="text" id="delete-user-id" required 
                                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <button type="submit" 
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600">
                            Remover Usuário
                        </button>
                        <div id="delete-user-message" class="mt-2 text-center text-sm"></div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <script>
        const API_BASE_URL = "http://localhost:3000/api";
        const DEVICE_ID = "MOC001";

        // Elementos de exibição
        const totalRevenueElement = document.getElementById('total-revenue');
        const totalUsersElement = document.getElementById('total-users');
        const usersTableBody = document.getElementById('users-table-body');
        const refreshUsersButton = document.getElementById('refresh-users-button');
        const usersLoadingMessage = document.getElementById('users-loading-message');

        // Formulários de gerenciamento de usuários
        const addUserForm = document.getElementById('add-user-form');
        const addUserIdInput = document.getElementById('new-user-id');
        const addUserNameInput = document.getElementById('new-user-name');
        const addUserBalanceInput = document.getElementById('new-user-balance');
        const addUserMessage = document.getElementById('add-user-message');

        const deleteUserForm = document.getElementById('delete-user-form');
        const deleteUserIdInput = document.getElementById('delete-user-id');
        const deleteUserMessage = document.getElementById('delete-user-message');

        // --- Funções de Busca de Dados ---

        async function fetchTotalRevenue() {
            try {
                const response = await fetch(`${API_BASE_URL}/revenue/${DEVICE_ID}`);
                if (!response.ok) throw new Error('Erro ao buscar receita');
                const data = await response.json();
                totalRevenueElement.textContent = `${data.totalRevenue.toFixed(2)} MT`;
            } catch (error) {
                console.error("Falha ao carregar receita:", error);
                totalRevenueElement.textContent = "ERRO MT";
            }
        }

        async function fetchUsers() {
            usersTableBody.innerHTML = '<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="3">Carregando usuários...</td></tr>';
            usersLoadingMessage.textContent = 'Aguarde, buscando dados...';
            refreshUsersButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/users`);
                if (!response.ok) throw new Error('Erro ao buscar usuários');
                const users = await response.json();

                totalUsersElement.textContent = users.length; // Atualiza o total de usuários
                usersTableBody.innerHTML = ''; // Limpa a tabela
                usersLoadingMessage.textContent = ''; // Limpa mensagem de carregamento

                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" colspan="3">Nenhum usuário cadastrado.</td></tr>';
                } else {
                    users.forEach(user => {
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.user_id}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${user.balance.toFixed(2)} MT</td>
                            </tr>
                        `;
                        usersTableBody.insertAdjacentHTML('beforeend', row);
                    });
                }
            } catch (error) {
                console.error("Falha ao carregar usuários:", error);
                usersTableBody.innerHTML = '<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-red-500" colspan="3">Erro ao carregar usuários.</td></tr>';
                usersLoadingMessage.textContent = 'Erro ao buscar dados. Verifique o console.';
            } finally {
                refreshUsersButton.disabled = false;
            }
        }

        // --- Funções de Gerenciamento de Usuários (Add/Delete) ---

        async function addUser(event) {
            event.preventDefault();
            addUserMessage.textContent = ''; // Limpa mensagens anteriores
            const userId = addUserIdInput.value.trim();
            const name = addUserNameInput.value.trim();
            const initialBalance = parseFloat(addUserBalanceInput.value);

            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, name, initialBalance })
                });
                const result = await response.json();

                if (result.success) {
                    addUserMessage.className = "mt-2 text-center text-sm text-green-600";
                    addUserMessage.textContent = result.message;
                    addUserForm.reset(); // Limpa o formulário
                    fetchUsers(); // Atualiza a lista de usuários
                } else {
                    addUserMessage.className = "mt-2 text-center text-sm text-red-600";
                    addUserMessage.textContent = result.message;
                }
            } catch (error) {
                console.error('Erro ao adicionar usuário:', error);
                addUserMessage.className = "mt-2 text-center text-sm text-red-600";
                addUserMessage.textContent = 'Erro de rede ou servidor.';
            }
        }

        async function deleteUser(event) {
            event.preventDefault();
            deleteUserMessage.textContent = ''; // Limpa mensagens anteriores
            const userId = deleteUserIdInput.value.trim();

            if (!confirm(`Tem certeza que deseja remover o usuário ${userId}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    deleteUserMessage.className = "mt-2 text-center text-sm text-green-600";
                    deleteUserMessage.textContent = result.message;
                    deleteUserIdInput.value = ''; // Limpa o input
                    fetchUsers(); // Atualiza a lista de usuários
                } else {
                    deleteUserMessage.className = "mt-2 text-center text-sm text-red-600";
                    deleteUserMessage.textContent = result.message;
                }
            } catch (error) {
                console.error('Erro ao remover usuário:', error);
                deleteUserMessage.className = "mt-2 text-center text-sm text-red-600";
                deleteUserMessage.textContent = 'Erro de rede ou servidor.';
            }
        }


        // --- Event Listeners e Inicialização ---

        // Atualizar lista de usuários ao clicar no botão
        refreshUsersButton.addEventListener('click', fetchUsers);
        // Lidar com o envio dos formulários
        addUserForm.addEventListener('submit', addUser);
        deleteUserForm.addEventListener('submit', deleteUser);


        // Carrega os dados na inicialização da página
        window.onload = function() {
            fetchTotalRevenue();
            fetchUsers();
            
            // Opcional: Atualiza a receita e usuários a cada X segundos
            setInterval(fetchTotalRevenue, 5000); // A cada 5 segundos
            // Não faz polling de usuários automaticamente, prefere o botão "Atualizar"
            // setInterval(fetchUsers, 10000); 
        };
    </script>
</body>
</html>